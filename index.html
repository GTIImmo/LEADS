<!-- Ajout du menu d√©roulant pour choisir le mois -->
<h3>Choisissez un mois :</h3>
<select id="monthSelection">
    <option value="">S√©lectionner un mois</option>
</select>

<!-- Ajout du menu d√©roulant pour choisir le jour -->
<h3>Choisissez un jour :</h3>
<select id="daySelection">
    <option value="">S√©lectionner un jour</option>
</select>

<h3>Choisissez un cr√©neau disponible :</h3>
<div class="calendar" id="calendar"></div>

<button class="button" id="confirmButton">Confirmer le Rendez-vous</button>
<p id="confirmation"></p>

<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log("‚úÖ Chargement du script");

    // üìå R√©cup√©rer les param√®tres de l'URL envoy√©s par Brevo
    const params = new URLSearchParams(window.location.search);
    const lead = {
        nom: params.get("nom") || "Client",
        prenom: params.get("prenom") || "",
        email: params.get("email") || "",
        telephone: params.get("telephone") || ""
    };

    // üìå Remplir la liste des mois (12 mois √† partir du mois en cours)
    const monthSelection = document.getElementById("monthSelection");
    for (let i = 0; i < 12; i++) {
        let date = new Date();
        date.setMonth(new Date().getMonth() + i);
        let option = document.createElement("option");
        option.value = date.getMonth();
        option.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        monthSelection.appendChild(option);
    }

    // üìå Mettre √† jour les jours disponibles lorsque le mois est s√©lectionn√©
    monthSelection.addEventListener("change", function () {
        if (this.value !== "") {
            generateDays(parseInt(this.value));
        }
    });

    function generateDays(selectedMonth) {
        const daySelection = document.getElementById("daySelection");
        daySelection.innerHTML = "<option value=''>S√©lectionner un jour</option>";
        let currentYear = new Date().getFullYear();
        let daysInMonth = new Date(currentYear, selectedMonth + 1, 0).getDate();

        for (let i = 1; i <= daysInMonth; i++) {
            let option = document.createElement("option");
            option.value = i;
            option.textContent = i;
            daySelection.appendChild(option);
        }
    }

    document.getElementById("daySelection").addEventListener("change", function () {
        if (this.value !== "") {
            generateTimeSlots(monthSelection.value, this.value);
        }
    });

    function generateTimeSlots(month, day) {
        const calendarEl = document.getElementById("calendar");
        calendarEl.innerHTML = ""; 
        let slots = [];

        for (let i = 9; i <= 17; i++) {  
            let date = new Date();
            date.setMonth(month);
            date.setDate(day);
            date.setHours(i, 0, 0, 0);
            slots.push({ label: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), date: date });
        }

        slots.forEach(slot => {
            let div = document.createElement("div");
            div.classList.add("slot");
            div.innerText = slot.label;
            div.onclick = function () {
                document.querySelectorAll(".slot").forEach(el => el.classList.remove("selected"));
                div.classList.add("selected");
                document.getElementById("confirmButton").style.display = "block";
                div.setAttribute("data-date", slot.date.toISOString());
            };
            calendarEl.appendChild(div);
        });
    }

    document.getElementById("confirmButton").addEventListener("click", function () {
        const selectedSlot = document.querySelector(".slot.selected");
        if (!selectedSlot) {
            alert("Veuillez choisir un cr√©neau.");
            return;
        }

        let date = selectedSlot.getAttribute("data-date");

        // üîπ Envoi des donn√©es √† Google Sheets via Google Apps Script (GET)
        let params = new URLSearchParams({
            nom: lead.nom,
            prenom: lead.prenom,
            email: lead.email,
            telephone: lead.telephone,
            rdvDate: date
        }).toString();

        let url = `https://script.google.com/macros/s/AKfycbyu0tqXmJmP5byDYEDLsUrvcN90f8cMoM25_NOAn60zfj9WZfF42Y4Xl6w07ZJ4u0Zh5w/exec?${params}`;

        console.log("üì§ Envoi des donn√©es :", url);

        fetch(url, { method: "GET" })
        .then(response => response.json())
        .then(data => {
            console.log("‚úÖ R√©ponse API :", data);
            if (data.success) {
                document.getElementById("confirmation").innerHTML = `‚úÖ Merci ${lead.prenom} ${lead.nom}, votre rendez-vous est confirm√©.`;
            } else {
                document.getElementById("confirmation").innerHTML = "‚ùå Erreur syst√®me, merci de prendre contact avec votre conseiller.";
            }
            document.getElementById("confirmation").style.display = "block";
        })
        .catch(error => {
            console.error("‚ùå Erreur API:", error);
            document.getElementById("confirmation").innerHTML = "‚ùå Erreur syst√®me, merci de prendre contact avec votre conseiller.";
            document.getElementById("confirmation").style.display = "block";
        });
    });
});
</script>
